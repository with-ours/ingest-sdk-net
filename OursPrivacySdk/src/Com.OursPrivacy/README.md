# Com.OursPrivacy SDK

## Usage

### Registering Your API Key

Before making API calls, register your API key(s) using the provided DI helpers.  
**Recommended:** Load your API key from configuration.

```csharp
// In your Program.cs or Startup.cs
var apiKey = builder.Configuration["OursPrivacy:ApiKey"] 
    ?? throw new InvalidOperationException("OursPrivacy:ApiKey is not configured.");

builder.Host.ConfigureOursPrivacy((context, services, options) =>
{
    options.ConfigureApiKey(apiKey);
    // ...other configuration...
});
```

---

### Configuring Batching

Configure batch size and timer. Batches will send when the batch size or timer is reached.

Note: `EnqueueIdentify` and `EnqueueTrack` must be used to utilize batching.

```csharp
options.AddEventBatch(
    batchSize: 2, // Number of events before sending
    maxWaitTime: TimeSpan.FromSeconds(10) // Max time to wait before sending
);
```

---

### Configuring HttpClient Policies

You can add Polly policies and other middleware to the API HttpClient:

```csharp
options.AddApiHttpClients(client =>
{
    client.BaseAddress = new Uri("https://dev-api.oursprivacy.com/");
}, builder =>
{
    builder
        .AddRetryPolicy(2)
        .AddTimeoutPolicy(TimeSpan.FromSeconds(5))
        .AddCircuitBreakerPolicy(10, TimeSpan.FromSeconds(30));
});
```

---

### Using the library in your project

```csharp
using Com.OursPrivacy.Api;
using Com.OursPrivacy.Client;
using Com.OursPrivacy.Model;
using Microsoft.Extensions.Hosting;

var builder = WebApplication.CreateBuilder(args);

// Load API key from configuration
var apiKey = builder.Configuration["OursPrivacy:ApiKey"] 
    ?? throw new InvalidOperationException("OursPrivacy:ApiKey is not configured.");

// Register OursPrivacyApi dependencies
builder.Host.ConfigureOursPrivacy((context, services, options) =>
{
    options.ConfigureApiKey(apiKey);
    options.AddApiHttpClients(client =>
    {
      // HttpClient configurations here
    }, builder =>
    {
        builder
            .AddRetryPolicy(2)
            .AddTimeoutPolicy(TimeSpan.FromSeconds(5))
            .AddCircuitBreakerPolicy(10, TimeSpan.FromSeconds(30));
    });
    options.AddEventBatch(2, TimeSpan.FromSeconds(10));
});

var app = builder.Build();

var api = app.Services.GetRequiredService<IOursPrivacyApi>();

// Example: Identify request with queue and batching
var identifyRequest = new IdentifyRequest(
    userId: "user-123",
    userProperties: new IdentifyRequestUserProperties { }
);

// Queues the request for batching
api.EnqueueIdentify(identifyRequest);

// Sends the request immediately without a queue or batching
IIdentifyApiResponse apiResponse = await api.IdentifyAsync(identifyRequest);
```

---

## Questions

- **What about HttpRequest failures and retries?**  
  Configure Polly in the IHttpClientBuilder as shown above.

- **Does an HttpRequest throw an error when the server response is not Ok?**  
  If the return type is `ApiResponse<T>`, no error will be thrown; check the `StatusCode` and `ReasonPhrase`.  
  If the return type is `T`, an exception will be thrown for non-success responses.

- **How do I validate requests and process responses?**  
  Use the provided `On` and `After` partial methods in the API classes.

---

## Api Information
- appName: Ours
- appVersion: 1.0.0
- appDescription: The Ours Server-Side REST API

## Build
This C# SDK is automatically generated by the [OpenAPI Generator](https://openapi-generator.tech) project.

- SDK version: 1.0.0
- Generator version: 7.14.0
- Build package: org.openapitools.codegen.languages.CSharpClientCodegen